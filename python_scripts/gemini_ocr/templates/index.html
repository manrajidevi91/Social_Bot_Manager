<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OCR HOME</title>

    <!-- Google Fonts Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Your Custom CSS Link -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Basic JS for dynamic model selection (optional enhancement) -->
    <!-- Inside the <head> or before the closing </body> tag -->
        <script>
            // Use JSON.parse with the 'safe' filter for supportedModels
            const supportedModels = JSON.parse('{{ supported_models | tojson | safe }}');
            // Get the default model passed from Flask
            const defaultModel = '{{ default_model | default("none") | safe }}'; // Use default filter for safety
    
            function updateModels() {
                const companySelect = document.getElementById('company');
                const modelSelect = document.getElementById('model');
                const selectedCompany = companySelect.value;
    
                // Clear existing options
                modelSelect.innerHTML = '<option value="" disabled selected>-- Select Model --</option>';
    
                if (supportedModels[selectedCompany] && supportedModels[selectedCompany].length > 0) {
                    modelSelect.disabled = false;
                    supportedModels[selectedCompany].forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName;
                        option.textContent = modelName;
                        // NO need to set 'selected' attribute here anymore
                        modelSelect.appendChild(option);
                    });
    
                    // *** ADD THIS PART ***
                    // After populating, try to set the default model value
                    // Check if the defaultModel belongs to the selected company and exists in the list
                    if (selectedCompany === 'gemini' && defaultModel && defaultModel !== 'none') {
                        // Check if the defaultModel is actually in the options we just added
                        const optionExists = Array.from(modelSelect.options).some(opt => opt.value === defaultModel);
                        if (optionExists) {
                             modelSelect.value = defaultModel; // Set the value of the select dropdown
                             console.log(`Default model '${defaultModel}' selected for ${selectedCompany}.`);
                        } else {
                             console.log(`Default model '${defaultModel}' not found in the options for ${selectedCompany}.`);
                        }
                    } else if (modelSelect.options.length > 1) {
                        // If no specific default or wrong company, maybe select the first *actual* model?
                        // modelSelect.selectedIndex = 1; // Uncomment to select the first available model
                    }
                    // *** END OF ADDED PART ***
    
                } else {
                     modelSelect.disabled = true; // Disable if no models for company or company not supported
                }
            }
    
            // --- Rest of your JavaScript functions (handleDragOver, handleSubmit, etc.) ---
            // Ensure updateModels() is called when the page loads AND when the company changes
            // (The onchange="updateModels()" in the company select already handles the change part)
    
            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                document.getElementById('drop-zone').classList.add('drag-over');
            }
            function handleDragLeave(event) {
                 document.getElementById('drop-zone').classList.remove('drag-over');
            }
            function handleDrop(event) {
                event.preventDefault();
                document.getElementById('drop-zone').classList.remove('drag-over');
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    // Check if file input exists before trying to assign
                    const fileInput = document.getElementById('file');
                    if (fileInput) {
                        fileInput.files = files;
                        updateFileName(fileInput); // Call updateFileName
                    }
                }
            }
            function updateFileName(input) {
                 const fileLabel = document.getElementById('file-label-text');
                 if(fileLabel){ // Check if label exists
                     const fileName = input.files.length > 0 ? input.files[0].name : 'Click or Drag & Drop File Here';
                     fileLabel.textContent = fileName;
                }
            }
    
             function handleSubmit(form) {
                const submitBtn = form.querySelector('.submit-btn');
                const progressIndicator = document.getElementById('progress-indicator'); // Get progress indicator
    
                if(submitBtn) { // Check if button exists
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'ðŸ“¤ Processing... Please Wait...';
                }
                if(progressIndicator) { // Check if indicator exists
                    progressIndicator.style.display = 'block';
                }
                return true; // Allow form submission
             }
    
            // Call updateModels when the DOM is ready to ensure elements exist
            document.addEventListener('DOMContentLoaded', updateModels);
    
        </script>
    <!-- Optional: MathJax for LaTeX rendering (if needed) -->  
    {% if content_mode == 'math' %}
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    {% endif %}

</head>
<body onload="updateModels()"> <!-- Update models on page load -->
    <div class="container">
        <h1>OCR ðŸš€</h1>
        <p class="subtitle">Image/PDF se Text aur Math Extract Karein (Multi-Model)</p>

        <!-- Flash Messages Area -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="alert alert-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        {% if not gemini_api_key_ok %}
            <div class="alert alert-warning">
                <strong>Warning:</strong> Gemini API Key not found or invalid. Gemini models are disabled. Please set the `GEMINI_API_KEY` environment variable.
            </div>
        {% endif %}


        <form method="post" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" onsubmit="return handleSubmit(this);">

            <div class="form-group">
                <label for="language">1. Language Select Karein:</label>
                <select name="language" id="language" required>
                    <option value="English">English</option>
                    <option value="Hindi" selected>Hindi</option>
                    <option value="Marathi">Marathi</option>
                    <option value="Bengali">Bengali</option>
                    <option value="Tamil">Tamil</option>
                    <option value="Telugu">Telugu</option>
                    <option value="Gujarati">Gujarati</option>
                    <option value="Punjabi">Punjabi</option>
                </select>
            </div>

            <div class="form-group">
                <label for="company">2. Company Select Karein:</label>
                <select name="company" id="company" required onchange="updateModels()">
                    <!-- Populate companies dynamically if needed, for now hardcode -->
                    <option value="gemini" {% if not gemini_api_key_ok %}disabled{% endif %}>Gemini {% if not gemini_api_key_ok %}(API Key Missing){% endif %}</option>
                    <!-- <option value="openai" disabled>OpenAI (Soon)</option> -->
                    <!-- <option value="ollama" disabled>Ollama (Soon)</option> -->
                </select>
            </div>

            <div class="form-group">
                <label for="model">3. Model Select Karein:</label>
                <select name="model" id="model" required {% if not gemini_api_key_ok %}disabled{% endif %}>
                    <option value="" disabled selected>-- Select Model --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
                 <small class="form-text">Model availability depends on the selected company.</small>
            </div>

            <div class="form-group">
                <label>4. Content Type Kya Hai?</label>
                <div class="radio-group">
                    <input type="radio" id="mode_text" name="content_mode" value="text" checked required>
                    <label for="mode_text">Normal Mode (MCQ)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="mode_math" name="content_mode" value="math">
                    <label for="mode_math">Math Mode (LaTeX MCQ)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="mode_raw" name="content_mode" value="raw">
                    <label for="mode_raw">Raw OCR Only (OCR to DOCX)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="mode_raw_math" name="content_mode" value="raw_math">
                    <label for="mode_raw_math">Raw Text (OCR + Math/LaTeX)</label>
                </div>
            </div>
         
            <div class="form-group">
                <label>5. Options:</label>
                 <div class="checkbox-group">
                     <input type="checkbox" id="generate_explanation" name="generate_explanation" value="on">
                     <label for="generate_explanation">Auto-Generate Explanation (AI)</label>
                 </div>
                 <div class="checkbox-group">
                     <input type="checkbox" id="generate_answer" name="generate_answer" value="on">
                     <label for="generate_answer">Auto-Generate Answer (AI) label like 'a', 'b', 'c'...</label>
                 </div>
            </div>

            <div class="form-group">
                <label for="file">6. File Upload Karein (PDF/JPG/PNG):</label>
                <!-- Drag and Drop Area -->
                <div id="drop-zone"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleDrop(event)">
                     <!-- Input ko pehle rakhna behtar ho sakta hai, ya baad mein, styling par depend karta hai -->
                    <input type="file" name="file" id="file" accept=".pdf,.jpg,.jpeg,.png" required onchange="updateFileName(this)">
                     <!-- P ko LABEL se replace kiya aur 'for="file"' add kiya -->
                    <label for="file" id="file-label-text">Click or Drag & Drop File Here</label>
                </div>
                 <small class="form-text">Max file size: 30MB</small>
            </div>

             <!-- Progress Indicator (Hidden by default) -->
             <div id="progress-indicator" style="display: none; text-align: center; margin: 15px 0; color: #007bff; font-weight: bold;">
                 Processing... This might take a minute or two depending on the file size and model.
             </div>

            <button type="submit" class="submit-btn" {% if not gemini_api_key_ok and supported_models.get('gemini', []) == [] %}disabled{% endif %}>
                 ðŸ“¤ Upload aur Process Karein
            </button>
             {% if not gemini_api_key_ok and supported_models.get('gemini', []) == [] %}
                 <small style="color: red; text-align: center; display: block; margin-top: 5px;">Cannot process without a valid API Key and available models.</small>
             {% endif %}
        </form>

    </div>

</body>
</html>