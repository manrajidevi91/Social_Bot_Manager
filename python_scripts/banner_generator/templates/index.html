<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Optional: Add Favicon -->
    <!-- <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}"> -->
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h1>BannerGen</h1>
        <div class="upload-section">
            <h2>Upload Template</h2>
            <form action="{{ url_for('upload_template') }}" method="post" enctype="multipart/form-data">
                <label for="template_file">Select HTML File:</label>
                <input type="file" id="template_file" name="template_file" accept=".html" required>
                <button type="submit">Upload & Create</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h2>Available Templates</h2>
        <div class="flash-messages-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="template-grid">
            {% if templates %}
                {% for tpl in templates %}
                <div class="template-card">
                    <div class="card-header">
                        <h3 title="{{ tpl.name|escape }}">{{ tpl.name }}</h3>
                        <div class="card-actions">
                            <button class="action-button edit-button" title="Replace Template HTML" onclick="openEditModal('{{ tpl.id }}', '{{ tpl.name|escape }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg>
                            </button>
                            <form action="{{ url_for('delete_template', template_id=tpl.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Delete Template \'{{ tpl.name|escape }}\'? This cannot be undone.');">
                                <button type="submit" class="action-button delete-button" title="Delete Template">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/></svg>
                                </button>
                            </form>
                        </div>
                    </div>

                     {% if tpl.preview_url %}
                     <img src="{{ tpl.preview_url }}"
                          alt="{{ tpl.name }} Preview"
                          class="preview-image"
                          loading="lazy"> <!-- Removed extra <div before else -->
                     {% else %}
                     <div class="preview-image-placeholder">No Preview Available</div>
                     {% endif %}

                    <div class="card-content">
                        <div>
                            <p class="placeholders">
                                <strong>Headers:</strong>
                                {% if tpl.placeholders %}
                                    <code>{{ tpl.placeholders|join(', ') }}</code>
                                {% else %}
                                    <span style="color: #e74c3c;">(No placeholders found)</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="card-buttons"> <!-- <<< Wrapper for buttons >>> -->
                            <button class="generate-button" onclick="openUploadModal('{{ tpl.id }}', '{{ tpl.name|escape }}')">
                                Generate Banners
                            </button>
                            <!-- <<< SAMPLE DOWNLOAD LINK >>> -->
                            <a href="{{ url_for('download_sample', template_id=tpl.id) }}"
                               class="sample-download-button"
                               title="Download Sample Excel with Headers"
                               download> <!-- Optional: suggest filename -->
                                Download Sample
                            </a>
                            <!-- <<< END SAMPLE DOWNLOAD LINK >>> -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No templates found. Upload your first template using the sidebar.</p>
            {% endif %}
        </div>
    </div>

    <!-- Upload Excel Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('uploadModal')" title="Close">×</span>
            <h3 id="modalTitle">Upload Excel Data</h3>
            <form id="modalUploadForm" action="" method="post" enctype="multipart/form-data">
                 <label for="modal_excel_file">Select Excel File (.xlsx):</label>
                 <input type="file" id="modal_excel_file" name="excel_file" accept=".xlsx" required>
                 <button type="submit">Generate & Download Zip</button>
            </form>
        </div>
    </div>

    <!-- Edit HTML Template Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editModal')" title="Close">×</span>
            <h3 id="editModalTitle">Replace Template HTML</h3>
            <form id="editModalForm" action="" method="post" enctype="multipart/form-data">
                 <label for="edit_template_file">Select New HTML File:</label>
                 <input type="file" id="edit_template_file" name="new_template_file" accept=".html" required>
                 <p class="modal-help-text">
                     Replaces existing HTML, updates placeholders, and regenerates the preview and sample file. <!-- Updated help text -->
                 </p>
                 <button type="submit">Replace HTML & Update</button>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>